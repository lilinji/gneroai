# AlphaFold 3 配置文件示例
# 用于集群环境的标准配置

# 基本设置
tool_name: "AlphaFold3"
version: "latest"
cuda_version: "12.2+"
container_path: "/hpcfs/fpublic/container/singularity/app/af3/af3.sif"
model_weights_path: "/hpcfs/fhome/USERNAME/models_weight"
database_path: "/hpcfs/fpublic/database/alphafold/af3/data"

# 计算资源配置
resources:
  single_protein:
    small: # < 500 氨基酸
      nodes: 1
      ntasks_per_node: 1
      cpus_per_task: 16
      gpus: 1
      gpu_type: "a40"
      memory: "64GB"
      time: "04:00:00"
      partition: "qgpu_a40"
      
    medium: # 500-1500 氨基酸
      nodes: 1
      ntasks_per_node: 1
      cpus_per_task: 24
      gpus: 2
      gpu_type: "a40"
      memory: "128GB"
      time: "12:00:00"
      partition: "qgpu_a40"
      
    large: # > 1500 氨基酸
      nodes: 1
      ntasks_per_node: 1
      cpus_per_task: 32
      gpus: 2
      gpu_type: "a800"
      memory: "256GB"
      time: "24:00:00"
      partition: "qgpu_a800"
  
  protein_complex:
    small: # < 1000 总长度
      nodes: 1
      ntasks_per_node: 1
      cpus_per_task: 24
      gpus: 2
      gpu_type: "a40"
      memory: "128GB"
      time: "12:00:00"
      partition: "qgpu_a40"
      
    large: # > 1000 总长度
      nodes: 1
      ntasks_per_node: 1
      cpus_per_task: 32
      gpus: 4
      gpu_type: "a800"
      memory: "256GB"
      time: "48:00:00"
      partition: "qgpu_a800"
  
  batch_processing:
    array_limit: 10  # 同时运行的数组任务数
    concurrent_jobs: 3
    nodes: 1
    ntasks_per_node: 1
    cpus_per_task: 32
    gpus: 2
    memory: "128GB"
    time: "48:00:00"
    partition: "qgpu_a40"

# 目录配置
directories:
  input: "./input"
  output: "./output"
  temp: "./temp"
  logs: "./logs"
  cache: "/tmp/af3_cache"
  work: "/work"

# 预测参数配置
prediction_settings:
  default:
    num_diffusion_samples: 5
    num_seed: 1
    
  high_quality:
    num_diffusion_samples: 5
    num_seed: 3
    
  fast:
    num_diffusion_samples: 3
    num_seed: 1
    
  batch:
    num_diffusion_samples: 3
    num_seed: 2

# 输入格式配置
input_formats:
  supported_types:
    - "protein"
    - "dna"
    - "rna" 
    - "ligand"
  
  json_schema_version: 1
  dialect: "alphafold3"
  
  sequence_limits:
    max_protein_length: 4000
    max_dna_length: 2000
    max_rna_length: 2000
    max_total_complex_length: 5000
    max_chains_per_complex: 10

# 输出配置
output_settings:
  file_formats:
    - "cif"  # 主要结构文件
    - "json" # 置信度数据
    - "csv"  # 排序评分
  
  compression:
    enable: true
    format: "gzip"
  
  cleanup:
    remove_temp_files: true
    keep_intermediate: false
    
  quality_thresholds:
    min_ptm_score: 0.3
    good_ptm_score: 0.5
    excellent_ptm_score: 0.8

# 性能优化设置
optimization:
  memory:
    pytorch_cuda_alloc_conf: "max_split_size_mb:512"
    cuda_mem_limit: "40000M"
  
  gpu:
    enable_mixed_precision: true
    enable_gpu_relax: true
    
  storage:
    use_tmp_for_scratch: true
    cleanup_interval: 24 # 小时

# 监控配置
monitoring:
  enable_logging: true
  log_level: "INFO"
  progress_tracking: true
  resource_monitoring: true
  
  alerts:
    enable: false
    memory_threshold: 90  # 百分比
    disk_threshold: 85    # 百分比

# 错误处理
error_handling:
  max_retries: 2
  retry_delay: 300  # 秒
  
  known_errors:
    cuda_oom:
      action: "reduce_batch_size"
      message: "GPU内存不足，请减少序列长度或增加GPU数量"
    
    json_format:
      action: "validate_input"
      message: "JSON格式错误，请检查输入文件"
    
    model_weights:
      action: "check_weights"
      message: "模型权重文件问题，请检查权重路径和文件完整性"

# 安全设置
security:
  input_validation:
    enable: true
    max_file_size: "100MB"
    allowed_extensions: [".json"]
  
  output_protection:
    enable: true
    permissions: "755"

# 版本兼容性
compatibility:
  alphafold3_versions:
    - "latest"
    - "2024.05"
  
  singularity_min_version: "3.6.0"
  cuda_min_version: "12.0"

# 集群特定配置
cluster_settings:
  scheduler: "slurm"
  default_account: null
  default_qos: null
  
  partitions:
    gpu_partitions:
      - "qgpu_3090"
      - "qgpu_a40" 
      - "qgpu_a800"
    
    cpu_partitions:
      - "compute"
      - "cpu"
  
  modules:
    required:
      - "singularity"
    optional:
      - "cuda/12.2"
      - "python/3.9"

# 用户指南
usage_examples:
  single_protein: "sbatch af3-single.slurm input.json output/"
  protein_complex: "sbatch af3-complex.slurm complex.json output/"
  batch_processing: "sbatch --array=1-N af3-batch.slurm input_dir/ output_dir/"

# 参考信息
references:
  paper: "Accurate structure prediction of biomolecular interactions with AlphaFold 3. Nature (2024)"
  github: "https://github.com/google-deepmind/alphafold3"
  documentation: "https://github.com/google-deepmind/alphafold3/blob/main/README.md"
  weight_request: "https://github.com/google-deepmind/alphafold3/blob/main/WEIGHTS.md"